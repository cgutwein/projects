---
title: "Sensor Plot Generation"
author: "Chet Gutwein"
date: "December 6, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plotly)
library(DT)
library(lubridate)
library(broom)
```

## Introduction

Generating charts for an interactive dashboard with time series data. We're using a sampling of data from the PostgreSQL database that houses air monitoring sensor data from a total of 4 devices.

```{r}
hist(pg_data$a_pm25_atm)
```


```{r}
p <- plot_ly(pg_data[pg_data$sensor_id == 7956,], x = ~created_on, y = ~a_pm25_atm, name = 'PM2.5 (ug/dscm) Sensor A',type = 'scatter',  mode = 'lines', line = list(color = '#7F7F7F')) %>%
  add_trace(y= ~a_pm1_atm, name = 'PM1 (ug/dscm) Sensor A', mode = 'lines', line = list(color = '#0000ff')) %>%
  add_trace(y = ~a_pm10_atm, name = 'PM10 (ug/dscm) Sensor A', mode = 'lines', line = list(color = '#ff0000')) %>%
  #add_trace(y = ~`4-Black`, name = 'System 4', mode = 'lines', line = list(color = '#000000')) %>%
  layout(title = "Ambient Level PM Concentration",
         xaxis = list(
           rangeselector = list(
             buttons = list(
               list(
                 count = 2,
                 label = "2 hr",
                 step = "hour",
                 stepmode = "backward"),
               list(
                 count = 1,
                 label = "1 hr",
                 step = "hour",
                 stepmode = "backward"),
               list(
                 count = 30,
                 label = "30 min",
                 step = "minute",
                 stepmode = "backward"),
               list(step = "all"))),
           
           rangeslider = list(type = "date")),
         yaxis = list (title = "Concentration (ug/dscm)"))
```

## Scatterplot for Agreement
Each Purple Air Sensor is equipped with redundant PM sensors. Agreement between to the two means the measurements are valid. Disagreement means one or more sensors are out of calibration and should be replaced.

```{r}
p2 <- plot_ly(
  pg_data[pg_data$sensor_id == 7956,], x = ~a_pm25_atm, y = ~b_pm25_atm,
  color = ~a_pm25_atm
)
```
```{r}
m <- lm(a_pm25_atm ~ b_pm25_atm, data = pg_data[pg_data$sensor_id == 7956,])

#m <- loess(a_pm25_atm ~ b_pm25_atm, data = pg_data)
p2a <- plot_ly(pg_data_2a[pg_data_2a$sensor_id == 7956,], x = ~a_pm25_atm, color = I("black")) %>%
  add_markers(y = ~b_pm25_atm, showlegend = FALSE) %>%
  add_lines(y = ~m$fitted.values,
            line = list(color = 'rgba(7, 164, 181, 1)'),
            name = "Loess Smoother") %>%
  layout(xaxis = list(title = 'Sensor A - PM2.5 (ug/dscm)'),
         yaxis = list(title = 'Sensor B - PM2.5 (ug/dscm)'),
         legend = list(x = 0.80, y = 0.90))
```

## Defining the AQI Color Palette

```{r}
sample_data <- pg_data[pg_data_2a$sensor_id == 7956,]$a_pm25_atm
```

## Air Quality Index
We'll be calculating the Air Quality Index (AQI) from the raw data values that are being generated by the air sensors. The AQI is a piecewise linear function that takes the form of:
$$
AQI = \frac{AQI_{high} - AQI_{low}}{C_{high} - C_{low}}(C - C_{low}) + AQI_{low}
$$
where:  
AQI = Air Quality Index,  
$C$ = pollutant concentration,  
$C_{low}$ = the concentration breakpoint that is less than $\leq{C}$,  
$C_{high}$ = the concentration breakpoint that is less than $\geq{C}$,  
$AQI_{low}$ = the AQI breakpoint corresponding to $C_{low}$,  
$AQI_{high}$ = the AQI breakpoint corresponding to $C_{high}$  

Each *criteria pollutant* has an AQI table with six categories (i.e. breakpoints) designated as **Good**, **Moderate**, **Unhealthy for Sensitive Groups**, **Unhealthy**, **Very Unhealthy**, and **Hazardous**.

```{r}
cols = c("category", "c_high", "c_low", "aqi_high", "aqi_low")
pm_table = data.frame(
  c("Good", "Moderate", "Unhealthy for Sensitive Groups", "Unhealthy", "Very Unhealthy", "Hazardous"),
  c(12, 35.4, 55.4, 150.4, 250.4, 500.4),
  c(0, 12, 35.4, 55.4, 150.4, 250.4),
  c(50, 100, 150, 200, 300, 500),
  c(0, 50, 100, 150, 200, 300)
)
colnames(pm_table) <- cols
```

```{r}
pm_aqi <- function(C){
  if (C > 500) {return(500)}
  else {
  for (i in 1:6) {
  if ((C >= pm_table$c_low[i]) & (C <= pm_table$c_high[i])) {
    return( ((pm_table$aqi_high[i] - pm_table$aqi_low[i]) / 
              (pm_table$c_high[i] - pm_table$c_low[i])) * (C - pm_table$c_low[i]) + pm_table$aqi_low[i])
  }
  }
  }
}
```

### Gauge Chart for Air Quality Index
https://plot.ly/r/gauge-charts/

```{r}
library(plotly)
base_plot <- plot_ly(
  type = "pie",
  values = c(40, 10, 3,5,5,5,10,22),
  sort=FALSE,
  labels = c("-", "0", "50", "100", "150", "200","300", "500"),
  rotation = 108,
  direction = "clockwise",
  hole = 0.4,
  textinfo = "label",
  textposition = "outside",
  hoverinfo = "none",
  #domain = list(x = c(0, 0.48), y = c(0, 1)),
  marker = list(colors = c('rgb(255, 255, 255)', 'rgb(255, 255, 255)', 'rgb(255, 255, 255)', 'rgb(255, 255, 255)', 'rgb(255, 255, 255)', 'rgb(255, 255, 255)', 'rgb(255, 255, 255)', 'rgb(255, 255, 255)')),
  showlegend = FALSE,
  width = 500, height = 600
)
```

```{r}
base_plot <- add_trace(
  base_plot,
  type = "pie",
  values = c(50, 5,5,5,5,10,20),
  sort = FALSE,
  labels = c("Air Quality Index", "Good", "Moderate", "Unhealthy for Sensitive Groups", "Unhealthy", "Very Unhealthy", "Hazardous"),
  rotation = 90,
  direction = "clockwise",
  hole = 0.3,
  textinfo = "label",
  textposition = "inside",
  hoverinfo = "none",
  #domain = list(x = c(0, 0.48), y = c(0, 1)),
  opacity = 0.5,
  marker = list(colors = c('rgb(255, 255, 255)', 'green', 'yellow', 'orange', 'red', 'purple', 'maroon')),
  showlegend= FALSE
)
```

```{r}
use_this_color <- aqi_master$aqi_colors[aqi_factorize(65)]
use_this_message <- aqi_master$aqi_levels[aqi_factorize(65)]

a <- list(
  showticklabels = FALSE,
  autotick = FALSE,
  showgrid = FALSE,
  zeroline = FALSE)

b <- list(
  xref = 'paper',
  yref = 'paper',
  x = 0.5,
  y = 0.25,
  showarrow = FALSE,
  text = 'Current AQI: 65',
  xanchor='center',
  font = list(color = 'white',
                              family = 'sans serif',
                              size = 26))

c <- list(
  xref = 'paper',
  yref = 'paper',
  x = 0.5,
  y = 0.15,
  showarrow = FALSE,
  text = use_this_message,
  xanchor='center',
  font = list(color = 'white',
                              family = 'sans serif',
                              size = 14))

m <- list(
  l = 50,
  r = 50,
  b = 100,
  t = 100,
  pad = 4
)

base_chart <- layout(
  base_plot,
  shapes = list(
    list(
      type = 'path',
      path = needle_pos(150),
      xref = 'paper',
      yref = 'paper',
      fillcolor = use_this_color
    ),
    list(
      type = 'path',
      path = 'M 0.0 0.0 L 0.0 0.4 L 1 0.4 L 1 0.0 Z',
      xref = 'paper',
      yref = 'paper',
      fillcolor = use_this_color
    )
  ),
  xaxis = a,
  yaxis = a,
  annotations = list(b,c),
  autosize = F, margin = m
)
```

We need to write a function that calculates the position of the gauge needle and write a string for the path. This will require some simple trigonometry.   

We know positions for $0$, $0.5$, and $1.0$ of full scale. So we can use the angle in between to calculate the x and y positions for the SVG gauge needle.

```{r}
needle_pos <- function(aqi_val){
  if (aqi_val >= 250) {
    alpha <- pi/180*(180 - (aqi_val*180/500))
    x_val <- (0.50 + 0.12*cos(alpha))
    y_val <- (0.50 + 0.12*sin(alpha))
    return(paste('M 0.495 0.5 L', x_val, y_val, 'L 0.505 0.5 Z'))}
  else {
    alpha <- 90*pi/180*aqi_val/250
    x_val <- (0.50 - 0.12*cos(alpha))
    y_val <- (0.50 + 0.12*sin(alpha))
    return(paste('M 0.495 0.5 L', x_val, y_val, 'L 0.505 0.5 Z'))}
}
```

## Proper Color Labeling and information.
To complete the gauge chart, we'll want to display some information pertaining to the AQI severity level and also color code the gauge needle and message accordingly. We'll need to create a static dataframe of information to do this.
```{r}
aqi_levels <- c("Good", "Moderate", "Unhealthy for Sensitive Groups", "Unhealthy", "Very Unhealthy", "Hazardous")
aqi_colors <- c('green', 'yellow', 'orange', 'red', 'purple', 'maroon')
aqi_messages <- c('Air quality is considered satisfactory, and air pollution poses little or no risk.',
                  'Air quality is acceptable; however, for some pollutants there may be a moderate health concern for a very small number of people. For example, people who are unusually sensitive to ozone may experience respiratory symptoms.',
                  'Although general public is not likely to be affected at this AQI range, people with lung disease, older adults and children are at a greater risk from exposure to ozone, whereas persons with heart and lung disease, older adults and children are at greater risk from the presence of particles in the air.',
                  'Everyone may begin to experience some adverse health effects, and members of the sensitive groups may experience more serious effects.',
                  'This would trigger a health alert signifying that everyone may experience more serious health effects.',
                  'This would trigger a health warnings of emergency conditions. The entire population is more likely to be affected.')
aqi_master <- cbind.data.frame(aqi_levels, aqi_colors, aqi_messages, stringsAsFactors = FALSE)
```
Now we'll need to map the AQI Value to the correct category. 
```{r}
aqi_factorize <- function(aqi_value) {cut(aqi_value, c(0, 50, 100, 150, 200, 300, 500), labels = FALSE)}
```




